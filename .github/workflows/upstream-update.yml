# TRLCore Upstream Update Workflow
# å®šæœŸæ£€æŸ¥å¹¶æ›´æ–°ä¸Šæ¸¸ Purpur ä»“åº“
name: Upstream Update

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 6:00 (åŒ—äº¬æ—¶é—´ 14:00) æ£€æŸ¥æ›´æ–°
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        type: boolean
        default: false

env:
  JAVA_VERSION: '21'
  UPSTREAM_REPO: 'PurpurMC/Purpur'
  UPSTREAM_BRANCH: 'ver/1.21.11'

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      upstream_commit: ${{ steps.check.outputs.upstream_commit }}
      current_commit: ${{ steps.check.outputs.current_commit }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check Upstream Updates
        id: check
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          UPSTREAM_COMMIT=$(git ls-remote https://github.com/${{ env.UPSTREAM_REPO }}.git refs/heads/${{ env.UPSTREAM_BRANCH }} | cut -f1)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          
          # è·å–å½“å‰ paperCommit
          CURRENT_COMMIT=$(grep 'paperCommit' gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          
          # æ¯”è¾ƒ
          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ] || [ "${{ inputs.force }}" == "true" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ å‘ç°ä¸Šæ¸¸æ›´æ–°: $CURRENT_COMMIT -> $UPSTREAM_COMMIT"
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: $CURRENT_COMMIT"
          fi

  update:
    needs: check-update
    if: needs.check-update.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
          
      - name: Configure Git
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          
      - name: Update Upstream Commit
        id: update
        run: |
          NEW_COMMIT="${{ needs.check-update.outputs.upstream_commit }}"
          OLD_COMMIT="${{ needs.check-update.outputs.current_commit }}"
          
          # æ›´æ–° gradle.properties
          sed -i "s/paperCommit = .*/paperCommit = $NEW_COMMIT/" gradle.properties
          
          # è·å–ä¸Šæ¸¸æäº¤ä¿¡æ¯
          COMMIT_MSG=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/commits/$NEW_COMMIT" | jq -r '.commit.message' | head -1)
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          
          # åˆ›å»ºåˆ†æ”¯
          BRANCH_NAME="upstream-update/$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
      - name: Test Build
        id: build
        continue-on-error: true
        run: |
          ./gradlew applyAllPatches --stacktrace
          ./gradlew build --stacktrace
          
      - name: Commit and Push
        run: |
          git add gradle.properties
          git commit -m "chore: update upstream to ${{ needs.check-update.outputs.upstream_commit }}"
          git push origin ${{ steps.update.outputs.branch }}
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.update.outputs.branch }}
          base: main
          title: "â¬†ï¸ Update upstream Purpur"
          body: |
            ## ä¸Šæ¸¸æ›´æ–°
            
            **ä¸Šæ¸¸ä»“åº“**: [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }})
            **åˆ†æ”¯**: `${{ env.UPSTREAM_BRANCH }}`
            
            ### å˜æ›´
            - **æ—§ç‰ˆæœ¬**: `${{ needs.check-update.outputs.current_commit }}`
            - **æ–°ç‰ˆæœ¬**: `${{ needs.check-update.outputs.upstream_commit }}`
            - **æäº¤ä¿¡æ¯**: ${{ steps.update.outputs.commit_msg }}
            
            ### æ„å»ºçŠ¶æ€
            ${{ steps.build.outcome == 'success' && 'âœ… æ„å»ºæˆåŠŸ' || 'âš ï¸ æ„å»ºå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®å¤è¡¥ä¸' }}
            
            ### ä¸Šæ¸¸å˜æ›´
            [æŸ¥çœ‹å®Œæ•´å˜æ›´](https://github.com/${{ env.UPSTREAM_REPO }}/compare/${{ needs.check-update.outputs.current_commit }}...${{ needs.check-update.outputs.upstream_commit }})
            
            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          labels: |
            upstream
            automated
          draft: ${{ steps.build.outcome != 'success' }}
